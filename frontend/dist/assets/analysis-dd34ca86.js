import{af as h,an as A,A as c}from"./index-9820d523.js";const g={getRelationshipGraph(t){const l=!!t.force_refresh,n={...t,force_refresh:l,_t:l?new Date().getTime():void 0};return console.log("[DEBUG API] getRelationshipGraph requestData:",JSON.stringify(n)),h({url:"/analysis/relationship-graph",method:"post",data:n,headers:l?{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}:{}})},getTimeline(t){return h({url:"/analysis/timeline",method:"post",data:t})},getCharacterJourney(t,l){return console.log(`[API] 请求角色旅程数据: 小说ID=${t}, 角色ID=${l}`),h({url:`/analysis/character-journey/${t}/${l}`,method:"get",validateStatus:function(n){return n>=200&&n<500},timeout:3e4}).catch(n=>{throw console.error("[API] 角色旅程请求失败:",n),n})},getItemLineage(t,l){return h({url:`/analysis/item-lineage/${t}/${l}`,method:"get"})},getLocationEvents(t,l){return h({url:`/analysis/location-events/${t}/${l}`,method:"get"})}},j=A("analysis",()=>{const t=c(null),l=c(null),n=c(null),p=c(null),m=c(null),i=c(!1),r=c(null),v=c({relationship:{}});async function d(s,o=null,a=1,e=!1){i.value=!0,r.value=null,console.log("[DEBUG] fetchRelationshipGraph 调用参数:",{novelId:s,characterId:o,depth:a,forceRefresh:e});const u=`${s}_${o||"null"}_${a}`;if(!e&&v.value.relationship[u])return console.log(`[DEBUG] 使用缓存数据 (cacheKey=${u})`),t.value=v.value.relationship[u],i.value=!1,t.value;try{const f=t.value;console.log(`[DEBUG] 发送API请求 (forceRefresh=${e})`);const y=await g.getRelationshipGraph({novel_id:s,character_id:o,depth:a,force_refresh:e});return console.log("[DEBUG] 收到API响应:",y.data?"数据有效":"数据无效"),t.value=y.data,v.value.relationship[u]=y.data,y.data}catch(f){throw console.error("[DEBUG] API请求失败:",f),r.value=f.message||"获取关系图失败",f}finally{i.value=!1}}function _(s,o=null,a=1){const e=`${s}_${o||"null"}_${a}`;return!!v.value.relationship[e]}async function $(s,o=null,a=null,e=null){i.value=!0,r.value=null;try{const u=await g.getTimeline({novel_id:s,character_id:o,start_chapter:a,end_chapter:e});return l.value=u.data,u.data}catch(u){throw r.value=u.message||"获取时间线失败",u}finally{i.value=!1}}async function D(s,o){i.value=!0,r.value=null,console.log(`[角色旅程] 开始获取, 小说ID: ${s}, 角色ID: ${o}`);try{const a=await g.getCharacterJourney(s,o);if(console.log("[角色旅程] API响应:",a.status,a.data?"有数据":"无数据"),a.data&&typeof a.data=="object"){const e=a.data;console.log("[角色旅程] 数据结构:",Object.keys(e).join(", ")),e.character||(console.log("[角色旅程] 缺少character字段，创建默认值"),e.character={name:"",description:"",alias:[]}),e.journey||(console.log("[角色旅程] 缺少journey字段，创建默认值"),e.journey={}),e.stats||(console.log("[角色旅程] 缺少stats字段，创建默认值"),e.stats={chapters_count:0,events_count:0,relationships_count:0}),e.stages||(console.log("[角色旅程] 缺少stages字段，创建默认值"),e.stages=[]),e.key_events||(console.log("[角色旅程] 缺少key_events字段，创建默认值"),e.key_events=[]),e.emotions||(console.log("[角色旅程] 缺少emotions字段，创建默认值"),e.emotions=[]),e.relationships||(console.log("[角色旅程] 缺少relationships字段，创建默认值"),e.relationships=[]),console.log("[角色旅程] 处理后的数据:",{character:e.character?"已设置":"缺失",stats:e.stats?"已设置":"缺失",stages:e.stages?`${e.stages.length}项`:"缺失",events:e.key_events?`${e.key_events.length}项`:"缺失",emotions:e.emotions?`${e.emotions.length}项`:"缺失",relationships:e.relationships?`${e.relationships.length}项`:"缺失"}),n.value=e}else console.error("[角色旅程] 获取角色旅程返回的数据格式不正确:",a.data),r.value="数据格式不正确",n.value=null;return n.value}catch(a){throw console.error("[角色旅程] 获取角色旅程失败:",a),r.value=a.message||"获取角色旅程失败",n.value=null,a}finally{i.value=!1}}async function G(s,o){i.value=!0,r.value=null;try{const a=await g.getItemLineage(s,o);return p.value=a.data,a.data}catch(a){throw r.value=a.message||"获取物品传承失败",a}finally{i.value=!1}}async function w(s,o){i.value=!0,r.value=null;try{const a=await g.getLocationEvents(s,o);return m.value=a.data,a.data}catch(a){throw r.value=a.message||"获取地点事件失败",a}finally{i.value=!1}}function E(){t.value=null,l.value=null,n.value=null,p.value=null,m.value=null,r.value=null}return{relationshipGraph:t,timeline:l,characterJourney:n,itemLineage:p,locationEvents:m,loading:i,error:r,fetchRelationshipGraph:d,fetchTimeline:$,fetchCharacterJourney:D,fetchItemLineage:G,fetchLocationEvents:w,hasRelationshipCache:_,reset:E}});export{g as a,j as u};
